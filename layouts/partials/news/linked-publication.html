{{ $relatedIds := .Params.related_publication_ids }}
{{ if $relatedIds }}
{{ $journals := slice }}
{{ $conferences := slice }}

{{/* 1. Gather all linked publications */}}
{{ range $id := $relatedIds }}
{{ $found := false }}
{{ range site.Data.journals }}
{{ if eq .id $id }}
{{ $journals = $journals | append (merge . (dict "type" "journal")) }}
{{ $found = true }}
{{ end }}
{{ end }}
{{ if not $found }}
{{ range site.Data.conferences }}
{{ if eq .id $id }}
{{ $conferences = $conferences | append (merge . (dict "type" "conference")) }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}

{{/* 2. Prioritization Logic: Journals first, then Conferences */}}
{{ $toDisplay := slice }}
{{ if gt (len $journals) 0 }}
{{ $toDisplay = $journals }}
{{ else if gt (len $conferences) 0 }}
{{ $toDisplay = $conferences }}
{{ end }}

{{/* 3. Render Section */}}
{{ if gt (len $toDisplay) 0 }}
<div
    class="linked-article-box not-prose p-5 my-10 bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl shadow-sm print:hidden">
    <h3 class="text-[8px] uppercase tracking-[0.2em] font-bold text-neutral-400 dark:text-neutral-500 mb-2"
        style="font-size: 14px !important;">
        {{ if gt (len $toDisplay) 1 }}Linked Publications{{ else }}Linked Publication{{ end }}
    </h3>

    {{ range $index, $pub := $toDisplay }}

    {{/* --- DYNAMIC BIBTEX GENERATION --- */}}
    {{ $formattedAuthors := slice }}
    {{ range $pub.authors }}
    {{ $parts := split . " " }}
    {{ if gt (len $parts) 1 }}
    {{ $last := index $parts (sub (len $parts) 1) }}
    {{ $firstParts := first (sub (len $parts) 1) $parts }}
    {{ $first := delimit $firstParts " " }}
    {{ $formattedAuthors = $formattedAuthors | append (printf "%s, %s" $last $first) }}
    {{ else }}
    {{ $formattedAuthors = $formattedAuthors | append . }}
    {{ end }}
    {{ end }}
    {{ $bibAuthors := delimit $formattedAuthors " and " }}

    {{ $pubType := $pub.type | default "journal" }}
    {{ $bibtex := "" }}
    {{ if eq $pubType "journal" }}
    {{ $bibtex = printf "@article{%s,\n title={%s},\n author={%s},\n journal={%s},\n year={%s}" $pub.id $pub.title
    $bibAuthors $pub.venue $pub.year }}
    {{ else }}
    {{ $bibtex = printf "@inproceedings{%s,\n title={%s},\n author={%s},\n booktitle={%s},\n year={%s}" $pub.id
    $pub.title $bibAuthors $pub.venue $pub.year }}
    {{ end }}
    {{ with $pub.volume }}{{ $bibtex = printf "%s,\n volume={%s}" $bibtex . }}{{ end }}
    {{ with $pub.issue }}{{ $bibtex = printf "%s,\n number={%s}" $bibtex . }}{{ end }}
    {{ with $pub.pages }}{{ $bibtex = printf "%s,\n pages={%s}" $bibtex . }}{{ end }}
    {{ with $pub.doi }}{{ $bibtex = printf "%s,\n doi={%s}" $bibtex . }}{{ end }}
    {{ with $pub.url }}{{ $bibtex = printf "%s,\n url={%s}" $bibtex . }}{{ end }}
    {{ $bibtex = printf "%s\n}" $bibtex }}

    <div class="pub-entry">
        {{/* Note: We omit the .pub-number column here as it's not a numbered list */}}
        <div class="pub-content">
            <div class="pub-title">{{ $pub.title }}</div>
            <div class="pub-authors">{{ delimit $pub.authors ", " }}</div>
            <div class="pub-venue">
                {{ if eq $pubType "preprint" }}
                Preprint. {{ $pub.venue }} ({{ $pub.year }})
                {{ else }}
                {{ $pub.venue }}
                {{- with $pub.volume }} {{ . }}{{ end }}
                {{- with $pub.issue }}({{ . }}){{ end }}
                {{- with $pub.pages }}: {{ . }}{{ end }}
                ({{ $pub.year }})
                {{- with $pub.address }}, {{ . }}{{ end }}
                {{- with $pub.note }}, {{ . }}{{ end }}
                {{ end }}
            </div>

            <div class="pub-buttons">
                {{ if eq $pubType "journal" }}
                {{ $link := "" }}
                {{ with $pub.doi }}
                {{ if findRE "^http" . }}{{ $link = . }}{{ else }}{{ $link = printf "https://doi.org/%s" . }}{{ end }}
                {{ else }}
                {{ with $pub.url }}{{ $link = . }}{{ end }}
                {{ end }}
                {{ with $link }}<a href="{{ . }}" target="_blank" class="pub-btn">Journal</a>{{ end }}
                {{ else }}
                {{ $link := "" }}
                {{ with $pub.url }}{{ $link = . }}{{ end }}
                {{ if not $link }}{{ with $pub.doi }}{{ $link = printf "https://doi.org/%s" . }}{{ end }}{{ end }}
                {{ with $link }}<a href="{{ . }}" target="_blank" class="pub-btn">Conference</a>{{ end }}
                {{ end }}

                {{ with $pub.preprint }}<a href="{{ . }}" target="_blank" class="pub-btn">Preprint</a>{{ end }}
                {{ with $pub.pdf }}<a href="{{ . }}" target="_blank" class="pub-btn">PDF</a>{{ end }}
                {{ with $pub.code }}<a href="{{ . }}" target="_blank" class="pub-btn">Code</a>{{ end }}
                <button onclick="copyBibTeX(this)" data-bibtex="{{ $bibtex }}"
                    class="pub-btn pub-btn-bibtex"><span>BibTeX</span></button>
            </div>
        </div>
    </div>
    {{ end }}
</div>

<style>
    /* 
       Exact styles from layouts/publications/list.html 
       Duplicated here to ensure identical rendering relative to the partial.
    */
    .pub-entry {
        display: flex;
        gap: 12px;
        padding: 16px 0;
        align-items: baseline;
    }

    .pub-entry+.pub-entry {
        border-top: 1px solid rgb(var(--color-neutral-200));
    }

    .dark .pub-entry+.pub-entry {
        border-top-color: rgb(var(--color-neutral-700));
    }

    /* Target the first pub-entry specifically for the linked box to align with header */
    .linked-article-box>h3+.pub-entry {
        padding-top: 0 !important;
    }

    .linked-article-box .pub-entry:last-child {
        padding-bottom: 0 !important;
    }

    .pub-content {
        flex-grow: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .pub-title {
        font-size: 15px;
        font-weight: 700;
        color: rgb(var(--color-neutral-900));
        line-height: 1.3;
    }

    .dark .pub-title {
        color: rgb(var(--color-neutral-100));
    }

    .pub-authors {
        font-size: 14px;
        color: rgb(var(--color-primary-600));
        line-height: 1.4;
    }

    .dark .pub-authors {
        color: rgb(var(--color-primary-400));
    }

    .pub-venue {
        font-size: 14px;
        font-style: italic;
        color: rgb(var(--color-neutral-600));
        line-height: 1.4;
    }

    .dark .pub-venue {
        color: rgb(var(--color-neutral-400));
    }

    .pub-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
    }

    .pub-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 24px;
        padding: 0 10px;
        font-size: 12px;
        font-weight: 500;
        color: rgb(var(--color-neutral-700));
        border: 1px solid rgb(var(--color-neutral-400));
        border-radius: 6px;
        background: transparent;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.1s;
    }

    .dark .pub-btn {
        color: rgb(var(--color-neutral-300));
        border-color: rgb(var(--color-neutral-500));
    }

    .pub-btn span {
        transition: opacity 0.1s ease-in-out;
    }

    .pub-btn:hover,
    .pub-btn:active,
    .pub-btn.copied {
        background: rgb(var(--color-primary-600));
        border-color: rgb(var(--color-primary-600));
        color: rgb(var(--color-neutral-100));
    }

    .dark .pub-btn:hover,
    .dark .pub-btn:active,
    .dark .pub-btn.copied {
        background: rgb(var(--color-primary-400));
        border-color: rgb(var(--color-primary-400));
        color: rgb(var(--color-neutral-900));
    }

    .pub-btn-bibtex {
        width: 65px;
    }
</style>

<script>
    const SYNC_DELAY_MS = -10;
    const FADE_DURATION_MS = 100;
    const AUTO_RESET_DELAY_MS = 1000;

    function copyBibTeX(button) {
        const bibContent = button.dataset.bibtex;
        const textSpan = button.querySelector('span');

        navigator.clipboard.writeText(bibContent).then(() => {
            textSpan.innerText = 'Copied!';
            button.classList.add('copied');

            setTimeout(() => {
                button.classList.remove('copied');
            }, AUTO_RESET_DELAY_MS);

            const textSequenceStart = Math.max(0, AUTO_RESET_DELAY_MS + SYNC_DELAY_MS);

            setTimeout(() => {
                textSpan.style.opacity = '0';
                setTimeout(() => {
                    textSpan.innerText = 'BibTeX';
                    requestAnimationFrame(() => {
                        textSpan.style.opacity = '1';
                    });
                }, FADE_DURATION_MS);
            }, textSequenceStart);
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }
</script>
{{ end }}
{{ end }}