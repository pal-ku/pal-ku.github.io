{{ $disableImageOptimization := site.Store.Get "disableImageOptimization" }}

{{ $useDefault := false }}
{{ $featured := "" }}
{{ $featuredURL := "" }}
{{ with .Params.featureimage }}
{{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
{{ if site.Params.hotlinkFeatureImage }}
{{ $featuredURL = . }}
{{ else }}
{{ $featured = resources.GetRemote . }}
{{ end }}
{{ else }}
{{ $featured = resources.Get . }}
{{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
{{ $images := .Resources.ByType "image" }}
{{ range slice "*background*" "*feature*" "*cover*" "*thumbnail*" }}
{{ if not $featured }}{{ $featured = $images.GetMatch . }}{{ end }}
{{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
{{ $default := site.Store.Get "defaultBackgroundImage" }}
{{ if $default.url }}
{{ $featuredURL = $default.url }}
{{ $useDefault = true }}
{{ else if $default.obj }}
{{ $featured = $default.obj }}
{{ $useDefault = true }}
{{ end }}
{{ end }}

{{/* generate image URL if not hotlink */}}
{{ if not $featuredURL }}
{{ with $featured }}
{{ $featuredURL = .RelPermalink }}
{{ if not (or $disableImageOptimization (eq .MediaType.SubType "svg")) }}
{{ $size := site.Store.Get "backgroundImageWidth" }}
{{ $featuredURL = (.Resize $size).RelPermalink }}
{{ end }}
{{ end }}
{{ end }}

{{ with $featuredURL }}
{{ $style := "" }}
{{ $defaultPosition := cond $useDefault site.Params.imagePosition false }}
{{ $pos := $.Params.imagePosition | default $defaultPosition }}

{{/* Robust handling for imagePosition.
If it's a number (like 0.3), convert to percentage (30%).
If it's 'top', 'bottom', 'center', etc., use as is.
*/}}
{{ if $pos }}
{{ $finalPos := $pos }}
{{/* Check if it's likely a decimal number (0.something) */}}
{{ if and (not (findRE "[a-zA-Z%]" (printf "%v" $pos))) (findRE "^0\\.[0-9]+$" (printf "%v" $pos)) }}
{{ $percent := (mul (float $pos) 100) }}
{{ $finalPos = printf "center %.0f%%" $percent }}
{{ end }}
{{ $style = printf "object-position: %s;" $finalPos }}
{{ end }}

<div class="overflow-hidden h-36 md:h-56 lg:h-72">
    <img src="{{ . }}" role="presentation" loading="eager" decoding="async" fetchpriority="high"
        class="w-full h-full nozoom object-cover" {{ if $style }}style="{{ $style | safeCSS }}" {{ end }}>
</div>
{{ end }}